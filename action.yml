name: "pglockanalyze"
description: >
  Runs pglockanalyze against the provided migration files listed in
  `input_files` and posts the results in PR annotations.

branding:
  icon: "database"
  color: "blue"

inputs:
  db-host:
    description: "PostgreSQL host"
    required: false
    default: "localhost"

  db-port:
    description: "PostgreSQL port"
    required: false
    default: "5432"

  db-name:
    description: "Database name"
    required: false
    default: "pgladb"

  db-user:
    description: "Database user"
    required: false
    default: "pglauser"

  db-password:
    description: "Database password"
    required: false
    default: "pglapass"

  input_files:
    description: |
      New-line separated list of migration **file paths** to analyse. Each file
      is processed individually. Ignored if `migrations_path` is provided.
    required: false

  migrations_path:
    description: "Directory or glob pattern pointing to migration files"
    required: false

  migration_command:
    description: >
      Command executed once for each pre-existing migration file. The file path
      is appended as the last argument when invoking the command.
    required: false

  migration_command_once:
    description: >
      Command executed a single time to apply all pre-existing migrations. The
      command is invoked without extra file arguments and is useful for tools
      that operate on migration directories.
    required: false

  pglockanalyze-version:
    description: "Version of pglockanalyze to use (default: latest)"
    required: false

  cli-flags:
    description: "Additional pglockanalyze CLI flags (optional)"
    required: false
    default: "--commit"


runs:
  using: "composite"

  steps:
    - name: Install Rust toolchain
      shell: bash
      run: |
        if ! command -v cargo >/dev/null; then
          curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        fi

    - name: Install pglockanalyze
      shell: bash
      env:
        PGLA_VERSION: ${{ inputs.pgla-version }}
      run: |
        if [[ -n "$PGLA_VERSION" ]]; then
          cargo install pglockanalyze --locked --force --version "$PGLA_VERSION"
        else
          cargo install pglockanalyze --locked --force
        fi

    - name: Ensure jq is available
      shell: bash
      run: |
        if ! command -v jq >/dev/null; then
          sudo apt-get update -y
          sudo apt-get install -y jq
        fi

    - name: Run pglockanalyze and post annotations
      shell: bash
      env:
        DB_HOST:      ${{ inputs['db-host'] }}
        DB_PORT:      ${{ inputs['db-port'] }}
        DB_NAME:      ${{ inputs['db-name'] }}
        DB_USER:      ${{ inputs['db-user'] }}
        DB_PASS:      ${{ inputs['db-password'] }}
        INPUT_FILES:  ${{ inputs.input_files }}
        CLI_FLAGS:    ${{ inputs['cli-flags'] }}
        MIGRATIONS_PATH: ${{ inputs.migrations_path }}
        MIGRATION_COMMAND: ${{ inputs.migration_command }}
        MIGRATION_COMMAND_ONCE: ${{ inputs.migration_command_once }}
        BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha }}
        HEAD_SHA: ${{ github.event.pull_request.head.sha || github.event.merge_group.head_sha }}
      run: |
        "${{ github.action_path }}/run.sh"
